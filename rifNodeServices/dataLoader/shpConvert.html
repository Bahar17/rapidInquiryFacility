<html>
<head>
    <script src="jquery-2.2.3.js"></script> 
    <link rel="stylesheet" href="leaflet/leaflet.css" />
    <script src="leaflet/leaflet.js"></script>
    <script src="topojson.min.js"></script>
    <link rel="stylesheet" href="leaflet.zoomdisplay.css" />
    <script src="leaflet.zoomdisplay.js"></script>
    <script src="jquery.form.js"></script> 
<!--    <script src="angular.min.js"></script> -->
    <script src="async.js"></script> 
    <script src="nodeGeoSpatialFrontEnd.js"></script> 
    <script src="Control.FullScreen.js"></script>
	<link rel="stylesheet" href="Control.FullScreen.css" />
	<script src="Control.Loading.js"></script>
	<link rel="stylesheet" href="Control.Loading.css" />
	<script type="text/javascript" src="sizeof.js"></script>
		
    <script> 
// wait for the DOM to be loaded 
// prepare the JQuery form when the DOM is ready 
$(document).ready(function documentReady() { 
    var options = { 
        target:        '#shpConvert',   	// target element(s) to be updated with server response 
        beforeSubmit:  checkRequest,  		// pre-submit callback 
        success:       processJson,  		// post-submit callback 
		error:		   errorHandler, 		// Error handler callback
		uploadProgress: uploadProgressHandler,	// uploadProgress handler
		data: 			{uuidV1: "1"}, 		// Add randomised reference		
        // other available options: 
        //url:       url         // override for form's 'action' attribute 
        //type:      type        // 'get' or 'post', override for form's 'method' attribute 
        dataType:    'json',        		// 'xml', 'script', or 'json' (expected server response type) 
		ifrmae: true,						// This is to fix a spurious error Message:{"readyState":0,"responseText":"","status":0,"statusText":"error"} issues with firefox and ajax
											// Only 
        //clearForm: true        // clear all form fields after successful submit 
        //resetForm: true        // reset the form after successful submit 
 
        // $.ajax options can be used here too, for example: 
        timeout:     180000    // mS - 10 minutes
		
    }; 
	
    // bind form using 'ajaxForm' 
	try {
		$('#shpConvert').ajaxForm(options); 
	}
	catch (e) {
		console.error("Caught error in ajaxForm(): " + e.message);
	}
	
	document.getElementById("status").innerHTML = "Ready.";
	console.log("Ready");
}); 

var fileCount=0;
	
/*
 * Function: 	checkRequest()
 * Parameters:  formData, jqForm, options
 * Returns: 	true/false. False prevents form submitting!
 * Description:	Pre-submit callback handler for JQuery form
 */
function checkRequest(formData, jqForm, options) { 
    // formData is an array; here we use $.param to convert it to a string to display it 
    // but the form plugin does this for you automatically when it submits the data 
		 	
	options.data.uuidV1=generateUUID();
	console.log("uuidV1: " + options.data.uuidV1);
	
    var queryString = $.param(formData); 
/*
formData: Array[4]
0:
Object {
name: "file"
type: "file"
value: File Object {
lastModified: 1464097549540
lastModifiedDate: Tue May 24 2016 14:45:49 GMT+0100 (GMT Daylight Time)
name: "SAHSU_GRD_Level4.json"
size: 5562945
type: "",
webkitRelativePath: ""} .. then inherited

*/	
	for (var i=0; i<formData.length; i++) {
		var value=formData[i].value;
		if (formData[i].type == "file" && !value.name) {
			console.log("Formdata: null file");
		}
		else if (formData[i].type == "file") {
			console.log("Formdata file[" + i + "]: " + value.name + "; size: " + value.size + "; last modified: " + value.lastModifiedDate);
			fileCount++;
		}
		else if (formData[i].type == "checkbox") {
			if (formData[i].required) {
				console.log("Formdata file[" + i + "] mandatory field: " + formData[i].name + "=" + formData[i].value);	
			}
			else {
				console.log("Formdata file[" + i + "] field: " + formData[i].name + "=" + formData[i].value);	
			}
		}		
		else if (formData[i].type == "range") {
			if (formData[i].required) {
				console.log("Formdata file[" + i + "] mandatory field: " + formData[i].name + "=" + formData[i].value);	
			}
			else {
				console.log("Formdata file[" + i + "] field: " + formData[i].name + "=" + formData[i].value);	
			}
		}
		else if (formData[i].type == "select-one") {
			if (formData[i].required) {
				console.log("Formdata file[" + i + "] mandatory field: " + formData[i].name + "=" + formData[i].value);	
			}
			else {
				console.log("Formdata file[" + i + "] field: " + formData[i].name + "=" + formData[i].value);	
			}
		}
		else {
			console.log("Formdata other [" + i + "]: " + JSON.stringify(formData[i], null, 4));
		}
	}
	if (fileCount == 0) {
		document.getElementById("status").innerHTML = "<h1>No files selected</h1>"
		console.log("FATAL! No files selected");
		return false;
	}
	
    // jqForm is a jQuery object encapsulating the form element.  To access the 
    // DOM element for the form do this: 
    // var formElement = jqForm[0]; 
	if (!setupMap) {
		document.getElementById("status").innerHTML = "<h1>setupMap() not defined: errors in nodeGeoSpatialServices.js</h1>"
		console.log("FATAL! setupMap() not defined: errors in nodeGeoSpatialServices.js");
		return false;
	}
    console.log('About to submit: ' + JSON.stringify(queryString, null, 4)); 
	nodeGeoSpatialFrontEndInit();
 
    // here we could return false to prevent the form from being submitted; 
    // returning anything other than false will allow the form submit to continue 
    return true; 
} 
 
/*
 * Function: 	processJson()
 * Parameters:  data, status
 * Returns: 	Nothing
 * Description:	Post-submit callback for JQuery form
 * 				Do not use setStatus or you become devine 
 */
function processJson(data, status) { 
    // 'data' is the json object returned from the server 
	if (!data) {
		document.getElementById("status").innerHTML = "FATAL: processJson(): data undefined";
		console.error("FATAL: processJson(): data undefined");
	}

	try {
		if (status == "success") {
			displayResponse(data, 200, "Shapefile");
		}
		else {
			displayResponse(data, status, "Shapefile");
		}
	}
	catch (e) {
		document.getElementById("status").innerHTML = "<h1>FATAL: Caught exception in displayResponse()</h1><h2>Error message: " + e.message + "</h2>";
		console.error("FATAL: Caught exception in displayResponse(): " + e.message);	
	}
}	

function updateSimplificationFactorInput(val) {
      document.getElementById('simplificationFactorInput').value=val; 
}
	
/*
 * Angular controller
 */
// var app = angular.module('shpConvert', []);
// app.controller('shpConvertCtrl', function shpConvertCtrl($scope) {
//});

    </script>
<title>Shapefile to TopoJSON Convertor</title>
</head>
  <body onload="setupMap();">
    <div ng-app="shpConvert" ng-controller="shpConvertCtrl">
      <div id="header">
        <h4>Shapefile Upload</h4>
      </div>
      <div id="nav">
        <form id="shpConvert" action="http://127.0.0.1:3000/shpConvert" method="POST"
              enctype="multipart/form-data">Select a file/files to upload: <input type="file" name="file" size="50" multiple="multiple" />
          &nbsp;Simplification factor: <input id="simplificationFactor" name="simplificationFactor" type="range" defaultValue="0.75" value="0.75" min="0.1" max="1" step="0.05" onchange="updateSimplificationFactorInput(this.value);" />
		  <input type="text" id="simplificationFactorInput" value="0.75" readonly size="4">
<!--
 *
 * Zoomlevel		Quantization
 * ---------		------------
 *
 * <=6				1,500
 * 7				3,000
 * 8				5,000
 * 9				10,000
 * 10				100,000
 * 11				1,000,0000
 *
 -->
		  &nbsp;Quantization: <select id="quantizationSelect" name="quantization" form="shpConvert">
		    <option value="100000000">1 in 100 million</option>
		    <option value="10000000">1 in 10 million</option>
		    <option value="1000000" selected="selected">1 in 1 million</option>
		    <option value="100000">1 in 100,000</option>
		    <option value="10000">1 in 10,000</option>
		    <option value="5000">1 in 5,000</option>
		    <option value="3000">1 in 3,000</option>
		    <option value="1500">1 in 1,500</option>
		  </select>	
          &nbsp;Diagnostics<input id="diagnostics" type="checkbox" name="verbose" value="true">
          <input id="submit" type="submit" value="Upload File(s)" />&nbsp;
        </form>	
      </div>
	  <div id="status"></div>
	  <div id="map"></div>
	  <div id="footer">Copyright &copy; UK Small Area Health Statistics Unit</div>
    </div>
    <style>
#header {
    background-color:black;
	width: 100%;
    height: 30px;
    color:white;
    padding:0px; 
    text-align:center;
}
#header.h4 {
}
#submit {
	float: right;
}
#nav {
    line-height:30px;
    background-color:#eeeeee;
    height: 60px;
	width: 100%
    float:left;
    padding-left:5px; 
    padding-right:5px; 
}
#status {
    width:600px;
    float:left;
    padding:5px; 
}
#footer {
    background-color:#eeeeee;
    color:black;
    clear:both;
    text-align:center;
    padding:5px; 
    height: 14px;
    vertical-align:bottom;
}
#save {
    float:right;
    padding:5px; 
    margin: 0 0 10px 10px;
}
#map {
	width:550px; 
	height:550px; 
    float:right;
}
#conversion {
    float:right;
}
table {
    color:rgb(0, 200, 255);
    font-family: courier;
    font-size:75%;
}
button {
    text-rendering: auto;
    color: initial;
    letter-spacing: normal;
    word-spacing: normal;
    text-transform: none;
    text-indent: 0px;
    text-shadow: none;
    display: inline-block;
    text-align: start;
    margin: 0em 0em 0em 0em;
    font: 12px Arial;
	border-radius: 12px;
}
.legend {
	text-align: left;
	line-height: 18px;
	background-color: #FFF;
	color: #555;
	border-radius: 5px;
    padding-left: 5px; 
    padding-right: 5px;
	padding-bottom: 5px;
}
.legend h4 {
	margin: 0 0 5px;
	color: #777;
}
.legend i {
	width: 18px;
	height: 18px;
	float: left;
	margin-right: 8px;
	opacity: 0.7;
}
    </style>
  </body>
</html>