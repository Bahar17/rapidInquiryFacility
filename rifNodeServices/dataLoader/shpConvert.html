<html>
  <head>
	<script src="jquery-2.2.3.js"></script> 
    <link rel="stylesheet" href="leaflet/leaflet.css" />
    <script src="leaflet/leaflet.js"></script>
    <script src="topojson.min.js"></script>
    <link rel="stylesheet" href="leaflet.zoomdisplay.css" />
    <script src="leaflet.zoomdisplay.js"></script>
    <script src="nodeGeoSpatialFrontEnd.js"></script> 
	
    <title>Shapefile Uploading Form</title>
  </head>
  <body onload="setupMap();">
    <div id="header">
      <h4>Shapefile Upload</h4>
    </div>
  <div id="nav">
	<form action="/shpConvert" method="POST" id="shpConvert"
		  enctype="multipart/form-data">
	  Select a set/sets of shapefile files to upload: <input type="file" id="files" size="50" multiple="multiple" />
	  <!-- Use multi file submit -->

      <input type="submit" id="submit_handle" style="display: none"> 
	  <div id="conversion"><!--
	  Select conversion:
	  <input type="radio" id="output_type_geojson" name="output_type" value="shp2GeoJSON" checked>GeoJSON
	  <input type="radio" id="output_type_topojson" name="output_type" value="shp2TopoJSON">TopoJSON
	  <input type="radio" id="output_type_wkt" name="output_type" value="shp2WKT">Well Known text (WKT) --></div></br>
	  Diagnostics:
	  <input type="checkbox" id="verbose" value="true">
	  <button type="button" id="save" onclick="submitForm()">Upload Files</button></br>	  
	</form>
  </div>
  <div id="workarea">
	<div id="status"></div>
	<div id="map"></div>
	<div id="footer">
	  Copyright &copy; UK Small Area Health Statistics Unit
	</div>
   </div>
    <style>
#header {
    background-color:black;
	width: 100%;
    height: 30px;
    color:white;
    padding:0px; 
    text-align:center;
}
#header.h4 {
}
#nav {
    line-height:30px;
    background-color:#eeeeee;
    height: 60px;
	width: 100%
    float:left;
    padding-left:5px; 
    padding-right:5px; 
}
#status {
    width:600px;
    float:left;
    padding:5px; 
}
#footer {
    background-color:#eeeeee;
    color:black;
    clear:both;
    text-align:center;
    padding:5px; 
    height: 14px;
    vertical-align:bottom;
}
#save {
    float:right;
    padding:5px; 
    margin: 0 0 10px 10px;
}
#map {
	width:550px; 
	height:550px; 
    float:right;
}
#conversion {
    float:right;
}
table {
    color:rgb(0, 200, 255);
    font-family: courier;
    font-size:75%;
}
button {
    text-rendering: auto;
    color: initial;
    letter-spacing: normal;
    word-spacing: normal;
    text-transform: none;
    text-indent: 0px;
    text-shadow: none;
    display: inline-block;
    text-align: start;
    margin: 0em 0em 0em 0em;
    font: 12px Arial;
	border-radius: 12px;
}
    </style>
    <script>
						
/*
 * Function: 	submitForm()
 * Parameters: 	None
 * Returns: 	Nothing
 * Description:	Submit form button
 */
function submitForm() {

	var files_elem=document.getElementById('files');
	var verbose=document.getElementById('verbose').checked;
	var output_type="shpConvert";
	var files = files_elem.files;
	var fileno = 0;
	var totalFileSize = 0;
	var timeout = 600*1000 // 600,000 ms; 10 minutes
	
	var request = new XMLHttpRequest();

    var formData = new FormData();
	var start = new Date().getTime();
	
	if (files.length == 0) {
		document.getElementById('status').innerHTML = "ERROR! No files selected, unable to upload.";
		return;
	}
	
	// Remove old map layers
	if (map) {
		map.eachLayer(function (layer) {
			console.log('Remove tileLayer');
			map.removeLayer(layer);
		});
	}
	
	if (verbose) { // i.e. diagnostics
		console.log('Verbose mode: ' + verbose);
		formData.append('verbose', verbose);
	}
	formData.append('uuidV1', generateUUID()); // Random reference
	
	try {
		request.open('POST', output_type);
			// Process results
	
		request.onreadystatechange = function() {
			
			if (request.readyState == 1) { 
				setStatus("Connected...");
			}
			else if (request.readyState == 2) { 
				setStatus("Request received...");
			}		
			else if (request.readyState == 3) { 
				setStatus("Processing request...");
			}
			else if (request.readyState == 4) {
				setStatus("Processing response..."); 
				displayResponse(request.response, request.status, "Shapefile");
			}
			else {		
				setStatus("request.onreadystatechange() unknown state: " + request.readyState, "readyState error");
			}
		}

		if (isIE() && request.timeout) {
			request.timeout = timeout;
			console.log('IE Timeout set: ' + timeout);
		}
		else {
			request.timeout = timeout;
			console.log('Timeout set: ' + timeout);
		}
		request.ontimeout = function(e) {
			var end=new Date().getTime();
			var elapsed=(end - start)/1000; // in S
			
			if (e) {
				setStatus("Processing timed out after " + (timeout/1000) + " seconds", e.message);	
			}
			else {
				setStatus("Processing timed out after " + (timeout/1000) + " seconds", "timeout error");	
			}
		}
		
	}
	catch (e) {
		var end=new Date().getTime();
		var elapsed=(end - start)/1000; // in S
			
		setStatus("ERROR! Unable to open for post to: http://127.0.0.1:3000/" + output_type, e.message);
		return;
	}
	
	// 
	request.upload.onprogress = function(evt) {
		var end=new Date().getTime();
		var elapsed=(end - start)/1000; // in S
			
		if (evt.lengthComputable) {
			var percentComplete = Math.round(evt.loaded * 100 / evt.total);
			if (percentComplete == 100) {
				var end=new Date().getTime();
				var elapsed=(end - start)/1000; // in S
		
				if (fileno != files.length) {
					setStatus("Uploaded file " + fileno + "/" + files.length + ": " + 
						percentComplete.toString() + '%' + "; total: " + fileSize(totalFileSize));	
				}
				else {
					setStatus("Uploaded all " + files.length + " files " + 
						percentComplete.toString() + '%' + "; total: " + fileSize(totalFileSize) + "; sending to server...");	
				}
			}
			else {
				document.getElementById('status').innerHTML = "Uploading file " + fileno + "/" + files.length + ": " + 
					percentComplete.toString() + '%' + "; total: " + fileSize(totalFileSize);
			}
		}
		else {
			console.error("[" + elapsed + "] " + "ERROR! Uploading files: unable to compute percent complete", "UNKNOWN");
		}
	}	

	// Process submitted files
	for (var fileno = 0; fileno < files.length; ++fileno) {
		var file=files[fileno];
		if (file !== null) {
				
			var name = file.name;
			var reader = new FileReader();

			reader.onload = function(event) {
				var arrayBuf = new Uint8Array(event.target.result);
				var arrayIndex = 0;		  
			}
			reader.onerror = function(err) {
				setStatus("ERROR! Unable to upload file + " + fileno + "/" + files.length + ": " + 
					name, err); 		
				return;
			}
			totalFileSize+=file.size;
			formData.append('file[]', file, name);
			console.log('Loading file [' + fileno + ']: ' + name + "; " + fileSize(file.size));	
			
			reader.readAsArrayBuffer(file);
		}
	}

	try {			
		setStatus("Sending to server...");
		request.send(formData);	
		return;
	}
	catch (e) {
		setStatus("ERROR! Unable to post to: http://127.0.0.1:3000/" + output_type, e.message);
		return;
	}		
//    request.sendAsBinary(formData); // Bad crash!!
  

}

</script>

  </body>
</html>