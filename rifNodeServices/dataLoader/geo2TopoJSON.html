<html>
<head>
    <script src="jquery-2.2.3.js"></script> 
    <link rel="stylesheet" href="leaflet/leaflet.css" />
    <script src="leaflet/leaflet.js"></script>
    <script src="topojson.min.js"></script>
    <link rel="stylesheet" href="leaflet.zoomdisplay.css" />
    <script src="leaflet.zoomdisplay.js"></script>
    <script src="jquery.form.js"></script> 
    <script src="nodeGeoSpatialFrontEnd.js"></script> 
 
    <script> 
// wait for the DOM to be loaded 
// prepare the JQuery form when the DOM is ready 
$(document).ready(function() { 
    var options = { 
        target:        '#geo2TopoJSON',   	// target element(s) to be updated with server response 
        beforeSubmit:  checkRequest,  		// pre-submit callback 
        success:       processJson,  		// post-submit callback 
		error:		   errorHandler, 		// Error handler callback
		uploadProgress: uploadProgressHandler,	// uploadProgress handler
		data: 			{uuidV1: "1"}, 		// Add randomised reference		
        // other available options: 
        //url:       url         // override for form's 'action' attribute 
        //type:      type        // 'get' or 'post', override for form's 'method' attribute 
        dataType:    'json'        // 'xml', 'script', or 'json' (expected server response type) 
        //clearForm: true        // clear all form fields after successful submit 
        //resetForm: true        // reset the form after successful submit 
 
        // $.ajax options can be used here too, for example: 
        //timeout:   3000 
		
    }; 
	
    // bind form using 'ajaxForm' 
    $('#geo2TopoJSON').ajaxForm(options); 
	
	console.log("Ready");
}); 

/*
 * Function: 	checkRequest()
 * Parameters:  formData, jqForm, options
 * Returns: 	true/false. False prevents form submitting!
 * Description:	Pre-submit callback handler for JQuery form
 */
function checkRequest(formData, jqForm, options) { 
    // formData is an array; here we use $.param to convert it to a string to display it 
    // but the form plugin does this for you automatically when it submits the data 
		 	
	options.data.uuidV1=generateUUID();
	console.log("uuidV1: " + options.data.uuidV1);
	
    var queryString = $.param(formData); 
/*
formData: Array[4]
0:
Object {
name: "file"
type: "file"
value: File Object {
lastModified: 1464097549540
lastModifiedDate: Tue May 24 2016 14:45:49 GMT+0100 (GMT Daylight Time)
name: "SAHSU_GRD_Level4.json"
size: 5562945
type: "",
webkitRelativePath: ""} .. then inherited

*/	
	var fileCount=0;
	for (var i=0; i<formData.length; i++) {
		var value=formData[i].value;
		if (formData[i].type == "file" && !value.name) {
			console.log("Formdata: null file");
		}
		else if (formData[i].type == "file") {
			console.log("Formdata file[" + i + "]: " + value.name + "; size: " + value.size + "; last modified: " + value.lastModifiedDate);
			fileCount++;
		}
		else if (formData[i].type == "checkbox") {
			if (formData[i].required) {
				console.log("Formdata file[" + i + "] mandatory field: " + formData[i].name + "=" + formData[i].value);	
			}
			else {
				console.log("Formdata file[" + i + "] field: " + formData[i].name + "=" + formData[i].value);	
			}
		}
		else {
			console.log("Formdata other [" + i + "]: " + JSON.stringify(formData[i].value, null, 4));
		}
	}
	if (fileCount == 0) {
		document.getElementById("status").innerHTML = "<h1>No files selected</h1>"
		console.log("FATAL! No files selected");
		return false;
	}
	
    // jqForm is a jQuery object encapsulating the form element.  To access the 
    // DOM element for the form do this: 
    // var formElement = jqForm[0]; 
	if (!setupMap) {
		document.getElementById("status").innerHTML = "<h1>setupMap() not defined: errors in nodeGeoSpatialServices.js</h1>"
		console.log("FATAL! setupMap() not defined: errors in nodeGeoSpatialServices.js");
		return false;
	}
    console.log('About to submit: \n\n' + JSON.stringify(queryString, null, 4)); 
	start = new Date().getTime();
 
    // here we could return false to prevent the form from being submitted; 
    // returning anything other than false will allow the form submit to continue 
    return true; 
} 
 
/*
 * Function: 	processJson()
 * Parameters:  data, status
 * Returns: 	Nothing
 * Description:	Post-submit callback for JQuery form
 * 				Do not use setStatus or you become devine 
 */
function processJson(data, status) { 
    // 'data' is the json object returned from the server 
	if (!data) {
		document.getElementById("status").innerHTML = "FATAL: processJson(): data undefined";
		console.error("FATAL: processJson(): data undefined");
	}

	try {
		if (status == "success") {
			displayResponse(data, 200, "GeoJSON");
		}
		else {
			displayResponse(data, status, "GeoJSON");
		}
	}
	catch (e) {
		document.getElementById("status").innerHTML = "<h1>FATAL: Caught exception in displayResponse()</h1><h2>Error message: " + e.message + "</h2>";
		console.error("FATAL: Caught exception in displayResponse(): " + e.message);	
	}
}	
    </script>
<title>GeoJSON to TOpoJSON Uploading Form</title>
</head>
  <body onload="setupMap();">
    <div id="header">
      <h4>WGS84 GeoJSON Upload</h4>
    </div>
  <div id="nav">
<form id="geo2TopoJSON" action="http://127.0.0.1:3000/geo2TopoJSON" method="POST"
      enctype="multipart/form-data">
Select a file/files to upload: <input type="file" name="file" size="50" multiple="multiple" />
<input type="submit" value="Upload File(s)" />
<input type="checkbox" name="verbose" value="true">Verbose<br>
</form>
  </div>
  <div id="workarea">
	<div id="status"></div>
	<div id="map"></div>
	<div id="footer">
	  Copyright &copy; UK Small Area Health Statistics Unit
	</div>
   </div>
    <style>
#header {
    background-color:black;
	width: 100%;
    height: 30px;
    color:white;
    padding:0px; 
    text-align:center;
}
#header.h4 {
}
#nav {
    line-height:30px;
    background-color:#eeeeee;
    height: 60px;
	width: 100%
    float:left;
    padding-left:5px; 
    padding-right:5px; 
}
#status {
    width:600px;
    float:left;
    padding:5px; 
}
#footer {
    background-color:#eeeeee;
    color:black;
    clear:both;
    text-align:center;
    padding:5px; 
    height: 14px;
    vertical-align:bottom;
}
#save {
    float:right;
    padding:5px; 
    margin: 0 0 10px 10px;
}
#map {
	width:550px; 
	height:550px; 
    float:right;
}
#conversion {
    float:right;
}
table {
    color:rgb(0, 200, 255);
    font-family: courier;
    font-size:75%;
}
button {
    text-rendering: auto;
    color: initial;
    letter-spacing: normal;
    word-spacing: normal;
    text-transform: none;
    text-indent: 0px;
    text-shadow: none;
    display: inline-block;
    text-align: start;
    margin: 0em 0em 0em 0em;
    font: 12px Arial;
	border-radius: 12px;
}
    </style>
  </body>
</html>