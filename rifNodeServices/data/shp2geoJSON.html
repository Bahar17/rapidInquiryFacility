<html>
  <head>
	<script src="https://code.jquery.com/jquery-2.2.1.js"></script> 
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
    <script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
    <title>Shapefile Uploading Form</title>
  </head>
  <body>
    <h3>Shapefile Upload:</h3>
    <form action="http://127.0.0.1:3000/shp2GeoJSON" method="POST" id="shp2GeoJSON"
          enctype="multipart/form-data">
      Select a set/sets of shapefile files to upload: <input type="file" id="files" size="50" multiple="multiple" /></br> <!-- Use multi file submit -->

      <input type="submit" id="submit_handle" style="display: none">
      <input type="hidden" id="store" name="store" value="false">
	  Select conversion:
	  <input type="radio" id="output_type_geojson" name="output_type" value="shp2GeoJSON" checked>GeoJSON
	  <input type="radio" id="output_type_topojson" name="output_type" value="shp2TopoJSON">TopoJSON
	  <input type="radio" id="output_type_wkt" name="output_type" value="shp2WKT">Well Known text (WKT)</br>
      Verbose mode:
      <input type="checkbox" id="verbose" value="true"></br>
	  
      <button type="button" id="save" onclick="submitForm()">Upload Files</button></br>	  
    </form>

    <div id="map"></div>
    <div id="status"></div>
	
    <script>	
/*
 * Function: 	generateUUID()
 * Parameters: 	None
 * Returns: 	RFC4122 version 4 compliant UUID
 * Description:	Generate a random UUID
 */
function generateUUID() { // Post by briguy37 on stackoverflow
    var d = new Date().getTime();
    if(window.performance && typeof window.performance.now === "function"){
        d += performance.now(); //use high-precision timer if available
    }
    var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = (d + Math.random()*16)%16 | 0;
        d = Math.floor(d/16);
        return (c=='x' ? r : (r&0x3|0x8)).toString(16);
    });
    return uuid;
}
	
/*
 * Function: 	submitForm()
 * Parameters: 	None
 * Returns: 	Nothing
 * Description:	Submit form button
 */
function submitForm() {

	var store=document.getElementById('store').value;
	var files_elem=document.getElementById('files');
	var verbose=document.getElementById('verbose').checked;
	var output_type="shp2GeoJSON";
	var files = files_elem.files;
	
	var request = new XMLHttpRequest();
  
    var formData = new FormData();
	
	if (verbose) {
		console.log('Verbose mode: ' + verbose);
		formData.append('verbose', verbose);
	}
	formData.append('my_reference', generateUUID()); // Random reference
	if (store) {
		console.log('Store [hidden]: ' + store);
		formData.append('store', store);
	}
	if (output_type) {
		if (document.getElementById('output_type_geojson').checked) {
			output_type="shp2GeoJSON";	
		}		
		else if (document.getElementById('output_type_topojson').checked) {
			output_type="shp2TopoJSON";	
		}		
		else if (document.getElementById('output_type_wkt').checked) {
			output_type="shp2WKT";	
		}
		console.log('POST method: ' + output_type);
	}

    request.open('POST', 'http://127.0.0.1:3000/' + output_type);
	
	document.getElementById("map").innerHTML = "";
	
	request.upload.onprogress = function(evt) {
		if (evt.lengthComputable) {
			var percentComplete = Math.round(evt.loaded * 100 / evt.total);
			document.getElementById('status').innerHTML = "Uploading files: " + percentComplete.toString() + '%';
		}
		else {
			document.getElementById('status').innerHTML = '"Uploading files: unable to compute percent complete';
		}
	}	
	
	// Process submitted files
	for (var i = 0; i < files.length; ++i) {
		var file=files[i];
		if (file !== null) {
				
			var name = file.name;
			var reader = new FileReader();

			reader.onload = function(event) {
				var arrayBuf = new Uint8Array(event.target.result);
				var arrayIndex = 0;		  
			}
			reader.onerror = function(err) {
				console.log('ERROR! [' + i + ']: ' + name + "; " + err); 			
			}
			var fileSize = "";
			if (file.size > 1024 * 1024) {
				fileSize = (Math.round(file.size * 100 / (1024 * 1024)) / 100).toString() + 'MB';
			} 
			else {
				fileSize = (Math.round(file.size * 100 / 1024) / 100).toString() + 'KB';
			}
			formData.append('file[]', file, name);
			console.log('Loading file [' + i + ']: ' + name + "; " + fileSize);	
			
			reader.readAsArrayBuffer(file);
		}
	}

    request.send(formData);	
//    request.sendAsBinary(formData); // Bad crash!!
  
	// Process results
	request.onreadystatechange = function() {
		if (request.readyState == 1) { 
			document.getElementById("status").innerHTML = "Connected...";
		}
		else if (request.readyState == 2) { 
			document.getElementById("status").innerHTML = "Request received...";
		}		
		else if (request.readyState == 3) { 
			document.getElementById("status").innerHTML = "Processing request...";
		}
		else if (request.readyState == 4) { 
			displayResponse(request.response, request.status)
		}
	};
}

/*
 * Function: 	displayResponse()
 * Parameters: 	Response text (JSON as a string), status code
 * Returns: 	Nothing
 * Description:	Display reponse from submit form
 */
function displayResponse(responseText, status) {
	var response;
	var msg="";
	var responseErrors=0;
	
	try {
		response=JSON.parse(responseText);
	} catch (e) {  
		document.getElementById("status").innerHTML = "<h1>Send Failed</h1><h2>Error parsing response: " +  
			e.message +"</h2><p>Reponse:" + responseText + "</p>";
		return;
	}
	
	if (response.error) {
		msg+="<p>Error message" + response.error + "</p>"
	}

	if (response.no_files) {
		msg+="<p>Files processed: " + response.no_files;
		if (response.file_list) {
			if (response.no_files >  0) {
				msg+="<table border=\"1\" style=\"width:100%\">" + 
				"<tr><th>File number</th><th>File</th><th>GeoJSON length</th>" +
				"<th>File size</th><th>Transfer time (S)</th><th>Geojson convert time (S)</th>" +
				"<th>Uncompress time (S)</th><th>Uncompressed file size</th>" + 
				"<th>SRID</th>" +
				"</tr>";
				for (i = 0; i < response.no_files; i++) {
					msg+="<tr><td>" + (i+1) + "</td><td>" + response.file_list[i].file_name + "</td><td>";
					if (response.file_list[i].geojson) {			
						try {
							var geojson = JSON.stringify(response.file_list[i].geojson);
							if (response.boundingBox && i == 1) {
								var map = L.map('map', {
										maxBounds: [{lon: response.boundingBox.xmin, lat: response.boundingBox.ymin} /* South West */,
											        {lon: response.boundingBox.xmax, lat: response.boundingBox.ymax} /* North East */],
										zoom: 13,
										minZoom: 6,
										maxZoom: 13}
									); // Fix co-ordinates from geojson
								var myLayer = L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpandmbXliNDBjZWd2M2x6bDk3c2ZtOTkifQ._QA7i5Mpkd_m30IGElHziw', {
									maxZoom: 13,
									attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
										'<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
										'Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
									id: 'mapbox.light'
								});
					
								myLayer.on('tileerror', function(error, tile) {
									console.log(error);
									console.log(tile);
								});
								myLayer.addTo(map);
								L.geoJson(geojson, {
									onEachFeature: onEachFeature
								}).addTo(map);
							}							
							msg+=geojson.length;
						} catch (e) {  							
							msg+="GeoJSON conversion error: " + e.message;
							responseErrors++;
						}
					}
					else {
						msg+="ERROR! no GeoJSON returned";
						responseErrors++;
					}
					msg+="</td><td>" + 
						(response.file_list[i].file_size || "Not Set") + "</td><td>" + 
						response.file_list[i].transfer_time + "</td><td>" +
						(response.file_list[i].geojson_time || "Not converted") + "</td><td>" + 
						(response.file_list[i].uncompress_time || "N/A") + "</td><td>" + 
						(response.file_list[i].uncompress_size || "N/A") + "</td><td>" +
						(response.file_list[i].srid || "No SRID") + "</td>" +
						"</tr>";
				}
			}
			msg+="</table>";
		}
		else {
			msg+="; no file list";
		}
		msg+="</p>";
	}

	if (response.file_list[0].srid) {
		console.log("SRID: " + response.file_list[0].srid);
	}	
		
	if (response.file_list[0].projection_name) {
		console.log("Projection name: " + response.file_list[0].projection_name);
	}	
	
	if (response.file_list[0].boundingBox) {
		console.log("Bounding box [" +
					"xmin: " + response.file_list[0].boundingBox.xmin + ", " +
					"ymin: " + response.file_list[0].boundingBox.ymin + ", " +
					"xmax: " + response.file_list[0].boundingBox.xmax + ", " +
					"ymax: " + response.file_list[0].boundingBox.ymax + "]");
	}

	if (response.fields) {
		var fieldCount=0;
		for (var field in response.fields) {
			fieldCount++;
			if (fieldCount == 1) {
				msg+="<p>Fields returned by shp2GeoJSON<ul>";
			}
			msg+="<li>" + field + "=" + response.fields[field] + "</li>";
		}
		if (fieldCount > 0) {
			msg+="</ul></p>";
		}
	}	
	
	if (response.message) {
		msg+="<p>Processing messages:</br><div id=\"div_message\" style=\"overflow:scroll; height: 400px\"><pre>" + response.message + "</pre></div?</p>"
	}
	
	if (response.diagnostic) {
		msg+="<p>Processing diagnostic:</br><pre>" + response.diagnostic + "</pre></p>";
	}	
	
	if (status == 200 && responseErrors == 0) {	
		document.getElementById("status").innerHTML = "<h1>Shapefile processed OK</h1>" + msg;
	}
	else if (status == 200 && responseErrors > 0) {	
		document.getElementById("status").innerHTML = "<h1>Shapefile processed OK; but with " + 
			responseErrors + " error(s) in response</h1>" + msg;
	}
	else {
		document.getElementById("status").innerHTML = "<h1>Send Failed: " + status + "</h1>" + msg;
	}
}
</script>

  </body>
</html>